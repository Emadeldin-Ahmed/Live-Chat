<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Chat with Typing Indicator</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f7f9fc;
    margin: 0; padding: 20px;
    display: flex; flex-direction: column; align-items: center;
    color: #222;
    min-height: 100vh;
  }
  #container {
    width: 480px; max-width: 95vw;
    background: white;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    padding: 20px;
    display: flex; flex-direction: column;
  }
  h2 {
    margin-top: 0;
    color: #1976d2;
    font-weight: 700;
  }
  button {
    background-color: #1976d2;
    border: none;
    color: white;
    padding: 12px;
    margin-bottom: 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 16px;
    transition: background-color 0.3s ease;
    width: 100%;
  }
  button:hover {
    background-color: #155fa0;
  }
  #auth-buttons button:nth-child(2) {
    background-color: #555;
  }
  #auth-buttons button:nth-child(2):hover {
    background-color: #333;
  }
  #signout-btn {
    display: none;
    margin-bottom: 20px;
  }
  #online-users {
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 6px;
    background: #fafafa;
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 20px;
  }
  #online-users h3 {
    margin-top: 0;
    margin-bottom: 10px;
    font-weight: 700;
  }
  #online-users ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }
  #online-users li {
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 6px;
    margin-bottom: 6px;
    border: 1px solid transparent;
    transition: background-color 0.2s, border-color 0.2s;
  }
  #online-users li:hover {
    background-color: #e3f0fc;
    border-color: #1976d2;
  }
  #online-users li.self {
    background-color: #c8defc;
    font-weight: 700;
    cursor: default;
    border-color: #1976d2;
  }
  #chat-area {
    display: none;
    flex-direction: column;
  }
  #chat-with {
    font-weight: 700;
    margin-bottom: 6px;
    color: #1976d2;
  }
  #typing-indicator {
    font-style: italic;
    font-size: 14px;
    min-height: 18px;
    margin-bottom: 6px;
    color: #555;
  }
  #messages {
    height: 280px;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 12px;
    overflow-y: auto;
    background: #f1f3f5;
    margin-bottom: 12px;
    font-size: 15px;
  }
  .message {
    margin-bottom: 10px;
  }
  .message .sender {
    font-weight: 700;
    margin-right: 6px;
  }
  #message-input {
    padding: 12px;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #ccc;
    outline-offset: 2px;
    margin-bottom: 10px;
    width: 100%;
    box-sizing: border-box;
  }
  #chat-type-select {
    margin-bottom: 12px;
    font-weight: 600;
    color: #1976d2;
  }
  #group-creation {
    margin-bottom: 12px;
  }
  #group-creation input {
    width: calc(100% - 110px);
    padding: 8px;
    margin-right: 6px;
    font-size: 14px;
  }
  #group-creation button {
    width: 100px;
    padding: 8px;
    font-size: 14px;
    margin-bottom: 12px;
  }
  #group-list-container {
    margin-bottom: 20px;
  }
  #group-list-container h3 {
    margin-top: 0;
    margin-bottom: 8px;
    font-weight: 700;
  }
  #group-list {
    max-height: 140px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 8px;
    background: #fafafa;
  }
  #group-list li {
    padding: 6px 10px;
    cursor: pointer;
    border-radius: 6px;
    border: 1px solid transparent;
    margin-bottom: 6px;
  }
  #group-list li:hover {
    background-color: #e3f0fc;
    border-color: #1976d2;
  }
</style>
</head>
<body>
  <div id="container">
    <h2>ðŸ’¬ Chat: Private & Groups with Online Users & Typing</h2>

    <div id="auth-buttons">
      <button id="google-signin-btn">Sign in with Google</button>
      <button id="guest-signin-btn">Continue as Guest</button>
    </div>

    <button id="signout-btn">Sign Out</button>

    <div id="online-users" style="display:none;">
      <h3>Online Users</h3>
      <ul id="online-list"></ul>
    </div>

    <div id="group-creation" style="display:none;">
      <input type="text" id="new-group-name" placeholder="New group name" />
      <button id="create-group-btn">Create Group</button>
    </div>

    <div id="group-list-container" style="display:none;">
      <h3>Your Groups</h3>
      <ul id="group-list"></ul>
    </div>

    <select id="chat-type-select" style="display:none;">
      <option value="none" disabled selected>Select chat type</option>
      <option value="private">Private Chat</option>
      <option value="group">Group Chat</option>
    </select>

    <div id="chat-area">
      <div id="chat-with"></div>
      <div id="typing-indicator"></div>
      <div id="messages"></div>
      <input id="message-input" placeholder="Type a message..." autocomplete="off" />
      <button id="send-btn">Send</button>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCs7FPXY5C4TtNl2N2HVOocbDz6gzSyeu0",
      authDomain: "chat-live-a1267.firebaseapp.com",
      databaseURL: "https://chat-live-a1267-default-rtdb.firebaseio.com",
      projectId: "chat-live-a1267",
      storageBucket: "chat-live-a1267.appspot.com",
      messagingSenderId: "285360741601",
      appId: "1:285360741601:web:4842d1c6d457d3e9e0eba0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Elements
    const googleBtn = document.getElementById('google-signin-btn');
    const guestBtn = document.getElementById('guest-signin-btn');
    const signOutBtn = document.getElementById('signout-btn');
    const authButtons = document.getElementById('auth-buttons');

    const onlineUsersDiv = document.getElementById('online-users');
    const onlineList = document.getElementById('online-list');

    const groupCreationDiv = document.getElementById('group-creation');
    const newGroupNameInput = document.getElementById('new-group-name');
    const createGroupBtn = document.getElementById('create-group-btn');
    const groupListContainer = document.getElementById('group-list-container');
    const groupList = document.getElementById('group-list');

    const chatTypeSelect = document.getElementById('chat-type-select');
    const chatArea = document.getElementById('chat-area');
    const chatWithDiv = document.getElementById('chat-with');
    const typingIndicator = document.getElementById('typing-indicator');
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    let currentUser = null;
    let currentUserName = null;

    let currentChatType = null; // 'private' or 'group'
    let currentChatId = null; // user id or group id
    let currentChatName = null;

    // Helper to get consistent private chat ID
    function getPrivateChatId(uid1, uid2) {
      return uid1 < uid2 ? uid1 + '_' + uid2 : uid2 + '_' + uid1;
    }

    // --- Authentication handlers ---
    googleBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(console.error);
    };
    guestBtn.onclick = () => {
      auth.signInAnonymously().catch(console.error);
    };
    signOutBtn.onclick = () => {
      if (currentUser) {
        removeUserOnline(currentUser.uid);
        stopTyping(false);
      }
      auth.signOut();
    };

    // --- Online users handling ---
    function setUserOnline(uid, name) {
      if (!uid) return;
      db.ref(`onlineUsers/${uid}`).set({ name });
      db.ref(`onlineUsers/${uid}`).onDisconnect().remove();
    }
    function removeUserOnline(uid) {
      if (!uid) return;
      db.ref(`onlineUsers/${uid}`).remove();
    }
    function loadOnlineUsers() {
      db.ref('onlineUsers').on('value', snapshot => {
        const users = snapshot.val() || {};
        onlineList.innerHTML = '';
        Object.entries(users).forEach(([uid, user]) => {
          const li = document.createElement('li');
          li.textContent = user.name || 'Unnamed';
          if(uid === currentUser.uid) {
            li.classList.add('self');
            li.title = "That's you!";
            li.style.cursor = 'default';
          } else {
            li.onclick = () => {
              currentChatType = 'private';
              currentChatId = getPrivateChatId(currentUser.uid, uid);
              currentChatName = user.name;
              chatTypeSelect.value = 'private';
              openChat();
            };
          }
          onlineList.appendChild(li);
        });
        if (onlineList.children.length === 0) {
          onlineList.innerHTML = '<em>No users online</em>';
        }
      });
    }

    // --- Group creation and list ---
    createGroupBtn.onclick = () => {
      const groupName = newGroupNameInput.value.trim();
      if (!groupName) return alert('Enter a group name.');
      // Create group with current user as initial member
      const groupRef = db.ref('groups').push();
      groupRef.set({
        name: groupName,
        members: { [currentUser.uid]: true }
      }).then(() => {
        newGroupNameInput.value = '';
      });
    };

    function loadUserGroups() {
      db.ref('groups').on('value', snapshot => {
        const groups = snapshot.val() || {};
        groupList.innerHTML = '';
        Object.entries(groups).forEach(([groupId, group]) => {
          // Show groups where current user is a member
          if (group.members && group.members[currentUser.uid]) {
            const li = document.createElement('li');
            li.textContent = group.name;
            li.onclick = () => {
              currentChatType = 'group';
              currentChatId = groupId;
              currentChatName = group.name;
              chatTypeSelect.value = 'group';
              openChat();
            };
            groupList.appendChild(li);
          }
        });
        if (groupList.children.length === 0) {
          groupList.innerHTML = '<em>No groups joined</em>';
        }
      });
    }

    // --- Open chat area ---
    function openChat() {
      chatArea.style.display = 'flex';
      chatWithDiv.textContent = (currentChatType === 'private' ? 'Private chat with ' : 'Group chat: ') + currentChatName;
      messagesDiv.innerHTML = '';
      typingIndicator.textContent = '';
      messageInput.value = '';
      messageInput.focus();

      stopTyping(false);

      // Remove old listeners for messages and typing
      if (currentChatType === 'private') {
        db.ref('privateChats/' + currentChatId + '/messages').off();
        db.ref('privateChats/' + currentChatId + '/typing').off();
      } else if (currentChatType === 'group') {
        db.ref('groupChats/' + currentChatId + '/messages').off();
        db.ref('groupChats/' + currentChatId + '/typing').off();
      }

      // Listen for messages
      if (currentChatType === 'private') {
        db.ref('privateChats/' + currentChatId + '/messages').on('child_added', snapshot => {
          const msg = snapshot.val();
          addMessageToChat(msg.name, msg.message, msg.senderUid === currentUser.uid);
        });
        listenTyping('privateChats/' + currentChatId + '/typing');
      } else if (currentChatType === 'group') {
        db.ref('groupChats/' + currentChatId + '/messages').on('child_added', snapshot => {
          const msg = snapshot.val();
          addMessageToChat(msg.name, msg.message, msg.senderUid === currentUser.uid);
        });
        listenTyping('groupChats/' + currentChatId + '/typing');
      }
    }

    // --- Add message to chat UI ---
    function addMessageToChat(senderName, message, isSelf) {
      const div = document.createElement('div');
      div.classList.add('message');
      div.style.textAlign = isSelf ? 'right' : 'left';
      div.innerHTML = `<span class="sender">${senderName}:</span> ${message}`;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // --- Typing indicator ---

    let typingTimeout = null;
    let typingRef = null;

    function startTyping() {
      if (!typingRef) return;
      typingRef.child(currentUser.uid).set(currentUserName);
      if (typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(stopTyping, 3000);
    }

    function stopTyping(removeFromDb = true) {
      if (typingTimeout) clearTimeout(typingTimeout);
      if (!typingRef) return;
      if (removeFromDb) typingRef.child(currentUser.uid).remove();
    }

    function listenTyping(path) {
      typingRef = db.ref(path);
      typingRef.on('value', snapshot => {
        const typingUsers = snapshot.val() || {};
        // Remove self from list
        delete typingUsers[currentUser.uid];
        const names = Object.values(typingUsers);
        if (names.length === 0) {
          typingIndicator.textContent = '';
        } else if (names.length === 1) {
          typingIndicator.textContent = `${names[0]} is typing...`;
        } else {
          typingIndicator.textContent = `${names.join(', ')} are typing...`;
        }
      });
    }

    messageInput.addEventListener('input', () => {
      if (!currentChatId) return;
      startTyping();
    });

    messageInput.addEventListener('blur', () => {
      stopTyping();
    });

    // --- Send message ---
    sendBtn.onclick = () => {
      const msg = messageInput.value.trim();
      if (!msg) return;
      if (!currentChatId) return alert('Select a chat first');

      const path = currentChatType === 'private' ? 'privateChats' : 'groupChats';
      db.ref(`${path}/${currentChatId}/messages`).push({
        name: currentUserName,
        message: msg,
        senderUid: currentUser.uid,
        timestamp: Date.now()
      });
      messageInput.value = '';
      stopTyping();
    };

    // --- Chat type selector ---
    chatTypeSelect.onchange = () => {
      // If user switches chat type without selecting chat, clear chat area
      currentChatType = chatTypeSelect.value;
      currentChatId = null;
      currentChatName = null;
      chatArea.style.display = 'none';
      messagesDiv.innerHTML = '';
      chatWithDiv.textContent = '';
      typingIndicator.textContent = '';
    };

    // --- Auth state ---
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        currentUserName = user.displayName || 'Guest #' + user.uid.substring(0,4);
        console.log('Signed in:', currentUserName);

        authButtons.style.display = 'none';
        signOutBtn.style.display = 'block';
        onlineUsersDiv.style.display = 'block';
        groupCreationDiv.style.display = 'block';
        groupListContainer.style.display = 'block';
        chatTypeSelect.style.display = 'block';

        setUserOnline(currentUser.uid, currentUserName);
        loadOnlineUsers();
        loadUserGroups();

      } else {
        console.log('Signed out');
        if (currentUser) {
          removeUserOnline(currentUser.uid);
          stopTyping();
        }
        currentUser = null;
        currentUserName = null;
        currentChatType = null;
        currentChatId = null;
        currentChatName = null;

        authButtons.style.display = 'block';
        signOutBtn.style.display = 'none';
        onlineUsersDiv.style.display = 'none';
        groupCreationDiv.style.display = 'none';
        groupListContainer.style.display = 'none';
        chatTypeSelect.style.display = 'none';
        chatArea.style.display = 'none';

        messagesDiv.innerHTML = '';
        onlineList.innerHTML = '';
        groupList.innerHTML = '';
        typingIndicator.textContent = '';
      }
    });

    // --- Online presence cleanup ---
    window.addEventListener('beforeunload', () => {
      if (currentUser) {
        removeUserOnline(currentUser.uid);
        stopTyping();
      }
    });
  </script>
</body>
</html>
