<!DOCTYPE html>
<html>
<head>
  <title>Live Chat</title>
  <style>
    body { font-family: Arial; margin: 20px; background-color: #f0f0f5; }
    #messages { border: 1px solid #ccc; background: #fff; height: 300px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
    input, button, select { margin-top: 5px; padding: 10px; font-size: 16px; width: 100%; box-sizing: border-box; }
    .message { margin-bottom: 8px; }
    #typing { font-style: italic; color: gray; margin-top: 5px; }
    h2, h3 { margin-top: 20px; }
    ul { padding-left: 20px; }
    li { margin-bottom: 5px; }
  </style>
</head>
<body>
  <h2>ðŸ’¬ Live Chat</h2>
  <div id="auth">
    <button onclick="signInWithGoogle()">Sign in with Google</button>
    <button onclick="continueAsGuest()">Continue as Guest</button>
  </div>

  <div id="chat" style="display:none;">
    <h3>Welcome, <span id="username"></span>!</h3>
    
    <div id="group-creation">
      <input id="group-name" placeholder="Create group..." />
      <button onclick="createGroup()">Create Group</button>
    </div>

    <div id="group-list-container">
      <h3>Your Groups</h3>
      <ul id="group-list"></ul>
    </div>

    <div id="browse-groups-container" style="display:none;">
      <h3>All Groups (Browse)</h3>
      <ul id="browse-group-list"></ul>
    </div>

    <div>
      <label for="chatType">Chat Type:</label>
      <select id="chatType">
        <option value="group">Group</option>
        <option value="private">Private</option>
      </select>
    </div>

    <div id="user-list-container">
      <h3>Online Users</h3>
      <ul id="user-list"></ul>
    </div>

    <div id="messages"></div>
    <div id="typing"></div>
    <input type="text" id="message" placeholder="Type a message..." oninput="updateTyping()" />
    <button onclick="sendMessage()">Send</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCs7FPXY5C4TtNl2N2HVOocbDz6gzSyeu0",
      authDomain: "chat-live-a1267.firebaseapp.com",
      databaseURL: "https://chat-live-a1267-default-rtdb.firebaseio.com",
      projectId: "chat-live-a1267",
      storageBucket: "chat-live-a1267.appspot.com",
      messagingSenderId: "285360741601",
      appId: "1:285360741601:web:4842d1c6d457d3e9e0eba0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser;
    let currentGroupId;
    let currentChatType = "group";

    const usernameEl = document.getElementById("username");
    const groupList = document.getElementById("group-list");
    const browseGroupList = document.getElementById("browse-group-list");
    const browseGroupContainer = document.getElementById("browse-groups-container");
    const userList = document.getElementById("user-list");
    const messagesDiv = document.getElementById("messages");
    const typingEl = document.getElementById("typing");
    const chatTypeSelect = document.getElementById("chatType");

    function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    }

    function continueAsGuest() {
      const name = prompt("Enter your name:");
      if (name) {
        auth.signInAnonymously().then(() => {
          currentUser.displayName = name;
        });
      }
    }

    function setUserOnline(uid, name) {
      db.ref("online/" + uid).set({ name });
      db.ref("online/" + uid).onDisconnect().remove();
    }

    function loadOnlineUsers() {
      db.ref("online").on("value", snapshot => {
        const users = snapshot.val() || {};
        userList.innerHTML = "";
        Object.entries(users).forEach(([uid, { name }]) => {
          const li = document.createElement("li");
          li.textContent = name;
          li.onclick = () => {
            currentGroupId = uid;
            currentChatType = "private";
            chatTypeSelect.value = "private";
            loadMessages();
          };
          userList.appendChild(li);
        });
      });
    }

    function createGroup() {
      const groupName = document.getElementById("group-name").value.trim();
      if (groupName) {
        const newGroupRef = db.ref("groups").push();
        newGroupRef.set({ name: groupName, members: { [currentUser.uid]: true } });
        document.getElementById("group-name").value = "";
      }
    }

    function loadUserGroups() {
      db.ref("groups").on("value", snapshot => {
        const groups = snapshot.val() || {};
        groupList.innerHTML = "";
        Object.entries(groups).forEach(([id, group]) => {
          if (group.members && group.members[currentUser.uid]) {
            const li = document.createElement("li");
            li.textContent = group.name;
            li.onclick = () => {
              currentGroupId = id;
              currentChatType = "group";
              chatTypeSelect.value = "group";
              loadMessages();
            };
            groupList.appendChild(li);
          }
        });
      });
    }

    function loadBrowseGroups() {
      db.ref("groups").on("value", snapshot => {
        const groups = snapshot.val() || {};
        browseGroupList.innerHTML = '';
        Object.entries(groups).forEach(([groupId, group]) => {
          const isMember = group.members && group.members[currentUser.uid];
          const li = document.createElement('li');
          li.textContent = group.name + (isMember ? ' âœ” Joined' : '');
          li.style.cursor = isMember ? 'default' : 'pointer';
          li.onclick = () => {
            if (!isMember) {
              db.ref(`groups/${groupId}/members/${currentUser.uid}`).set(true);
            }
          };
          browseGroupList.appendChild(li);
        });
      });
    }

    function loadMessages() {
      messagesDiv.innerHTML = "";
      const path = currentChatType === "group" ? `messages/${currentGroupId}` : `private/${currentUser.uid}_${currentGroupId}`;
      db.ref(path).off(); // remove previous listeners
      db.ref(path).on("child_added", (data) => {
        const msg = data.val();
        const div = document.createElement("div");
        div.className = "message";
        div.textContent = `${msg.name}: ${msg.text}`;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    function sendMessage() {
      const message = document.getElementById("message").value.trim();
      if (!message || !currentGroupId) return;

      const path = currentChatType === "group" ? `messages/${currentGroupId}` : `private/${currentUser.uid}_${currentGroupId}`;
      db.ref(path).push({ name: currentUser.displayName || "Guest", text: message });
      document.getElementById("message").value = "";
      updateTyping(true); // stop typing
    }

    function updateTyping(clear = false) {
      if (!currentGroupId) return;
      const typingPath = `typing/${currentChatType}/${currentGroupId}/${currentUser.uid}`;
      if (clear) {
        db.ref(typingPath).remove();
      } else {
        db.ref(typingPath).set(currentUser.displayName || "Guest");
        db.ref(typingPath).onDisconnect().remove();
      }
    }

    function watchTyping() {
      db.ref("typing").on("value", snapshot => {
        const data = snapshot.val() || {};
        const typeSection = data[currentChatType] || {};
        const chatTyping = typeSection[currentGroupId] || {};
        const names = Object.entries(chatTyping)
          .filter(([uid]) => uid !== currentUser.uid)
          .map(([_, name]) => name);
        typingEl.textContent = names.length ? `${names.join(", ")} typing...` : "";
      });
    }

    chatTypeSelect.onchange = () => {
      currentChatType = chatTypeSelect.value;
      if (currentGroupId) loadMessages();
    };

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        currentUser.displayName ||= prompt("Enter your name:");
        document.getElementById("auth").style.display = "none";
        document.getElementById("chat").style.display = "block";
        usernameEl.textContent = currentUser.displayName;
        setUserOnline(currentUser.uid, currentUser.displayName);
        loadOnlineUsers();
        loadUserGroups();
        loadBrowseGroups();
        browseGroupContainer.style.display = 'block';
        watchTyping();
      }
    });
  </script>
</body>
</html>
